#!/usr/bin/env bash
#
# bootstrap installs things.

# --------------
# Functions
# --------------

main() {
  DOTFILES_ROOT=$(realpath "$(dirname "${BASH_SOURCE[0]}")")

  sudo chown -R "$(whoami)" /usr/local/lib /usr/local/sbin

  if [ "$(dirname "$DOTFILES_ROOT")" != "$HOME" ]; then
    echo "Must have .dotfiles/ installed in home directory"
    exit 1
  fi

  if [ "$(id -u)" == "0" ]; then
    echo "FAILURE: This script must not be run as root"
    exit 1
  fi

  case "$1" in
  "install") install ;;
  "update") update ;;
  *) echo "Unsupported" ;;
  esac
}

install() {
  set -e

  # find the installers and run them iteratively
  while IFS= read -r -d '' installer; do
    echo ''
    echo "Running ${installer}"
    sh "${installer}" install
  done < <(find . -name "*install.sh" -print0)
}

update() {
  set -e

  # find the installers and run them iteratively
  while IFS= read -r -d '' installer; do
    echo ''
    echo "Running ${installer}"
    sh "${installer}" update
  done < <(find . -name "*install.sh" -print0)
}

# --------------
# Main Script
# --------------

main "$@"
